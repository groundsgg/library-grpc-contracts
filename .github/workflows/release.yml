name: Publish Release Packages

on:
  push:
    tags:
      - '*@*'
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: "25"
          cache: "gradle"

      - name: Extract package and version from tag
        id: tag_info
        shell: bash
        run: |
          set -euo pipefail

          tag_name="${GITHUB_REF#refs/tags/}"

          if [[ ! "$tag_name" == *@* ]]; then
            echo "Error: Tag does not match expected pattern (package@version)"
            exit 1
          fi

          # Extract package name and version from tag (e.g., player@v1.0.0)
          tag_package="${tag_name%%@*}"
          tag_version="${tag_name#*@v}"

          echo "Extracted package=$tag_package version=$tag_version"

          echo "package=$tag_package" >> "$GITHUB_OUTPUT"
          echo "version=$tag_version" >> "$GITHUB_OUTPUT"

      - name: Publish package
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION_OVERRIDE: ${{ steps.tag_info.outputs.version }}
        run: |
          ./gradlew ":${{ steps.tag_info.outputs.package }}:publish" -PversionOverride="$VERSION_OVERRIDE"
