name: Publish Branch Packages

on:
  push:
    branches:
      - main
      - 'feat/**'
      - 'fix/**'
      - 'refactor/**'
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        project: ["player", "stats", "status"]
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Java
        uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: "25"
          cache: "gradle"

      - name: Determine version and check changes
        id: version
        shell: bash
        run: |
          set -euo pipefail

          project="${{ matrix.project }}"
          ref="${{ github.ref }}"
          before="${{ github.event.before }}"
          after="${{ github.sha }}"

          # Check if project has changes
          if ! git diff --name-only "$before" "$after" -- "$project/" | grep -q .; then
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Read current version from build.gradle.kts
          current_version=$(grep -E '^\s*version\s*=' "$project/build.gradle.kts" | sed -E "s/.*version\s*=\s*[\"']?([^\"']+)[\"']?.*/\1/" | tr -d ' ')

          # Determine version based on branch type
          if [[ "$ref" == refs/heads/main ]]; then
            # Main branch: SNAPSHOT version
            snapshot_version="${current_version}-SNAPSHOT"
            echo "version=$snapshot_version" >> "$GITHUB_OUTPUT"
            echo "should_publish=true" >> "$GITHUB_OUTPUT"
          elif [[ "$ref" == refs/heads/feat/* ]] || [[ "$ref" == refs/heads/fix/* ]] || [[ "$ref" == refs/heads/refactor/* ]]; then
            # Feature branch: SNAPSHOT with branch name
            branch_name="${ref#refs/heads/}"
            sanitized_branch=$(echo "$branch_name" | sed 's/[^a-zA-Z0-9-]/-/g' | sed 's/--*/-/g' | sed 's/^-\|-$//g')
            snapshot_version="${current_version}-${sanitized_branch}-SNAPSHOT"
            echo "version=$snapshot_version" >> "$GITHUB_OUTPUT"
            echo "should_publish=true" >> "$GITHUB_OUTPUT"
          else
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish package
        if: steps.version.outputs.should_publish == 'true'
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION_OVERRIDE: ${{ steps.version.outputs.version }}
        run: |
          ./gradlew ":${{ matrix.project }}:publish" -PversionOverride="$VERSION_OVERRIDE"

